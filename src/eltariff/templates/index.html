<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eltariff AI - Skapa RISE-kompatibelt API | Sourceful</title>
    <meta name="description" content="Konvertera dina elnätstariffer till maskinläsbart RISE API-format med AI. Gratis verktyg från Sourceful Labs AB.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sourceful': {
                            'grey': '#2B2B2B',
                            'blue': '#2F4A66',
                            'green': '#017E7A',
                            'teal': '#00FF84',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .tab-active { border-bottom: 2px solid #017E7A; color: #017E7A; }
        .loading { opacity: 0.5; pointer-events: none; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .gradient-bg { background: linear-gradient(135deg, #2B2B2B 0%, #2F4A66 100%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- Header -->
    <header class="gradient-bg text-white">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" fill="#00FF84"/>
                        <path d="M50 20L65 45H55V80H45V45H35L50 20Z" fill="#2B2B2B"/>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold">Eltariff AI</h1>
                        <p class="text-sm text-gray-300">Skapa RISE-kompatibelt API</p>
                    </div>
                </div>
                <nav class="flex gap-6">
                    <a href="/" class="text-sourceful-teal font-medium">Skapa API</a>
                    <a href="/explorer" class="text-gray-300 hover:text-white">Utforska API</a>
                    <a href="/api/docs" class="text-gray-300 hover:text-white">API Docs</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <!-- Introduction -->
        <div class="bg-sourceful-green/10 border border-sourceful-green/30 rounded-lg p-6 mb-8">
            <h2 class="text-lg font-semibold text-sourceful-grey mb-2">Vad är detta?</h2>
            <p class="text-sourceful-grey/80">
                Detta verktyg hjälper svenska elnätsbolag att skapa ett maskinläsbart API för sina tariffer
                enligt <a href="https://github.com/RI-SE/Eltariff-API" class="text-sourceful-green underline hover:text-sourceful-blue">RISE Eltariff API-standarden</a>.
                Ladda upp din tariffbeskrivning, så genererar AI:n ett komplett deployment-paket med Docker.
            </p>
            <p class="text-sm text-sourceful-grey/60 mt-2">
                Rate limit: 10 AI-analyser per timme.
            </p>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left: Input -->
            <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-semibold text-sourceful-grey mb-4">1. Beskriv dina tariffer</h2>

                <!-- Tabs -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex gap-4">
                        <button onclick="showTab('text')" id="tab-text" class="pb-2 tab-active font-medium">Fritext</button>
                        <button onclick="showTab('pdf')" id="tab-pdf" class="pb-2 text-gray-500 font-medium">PDF</button>
                        <button onclick="showTab('url')" id="tab-url" class="pb-2 text-gray-500 font-medium">URL</button>
                    </nav>
                </div>

                <!-- Company info -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">Företagsnamn</label>
                    <input type="text" id="company-name" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green"
                           placeholder="T.ex. Sundsvall Elnät AB">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">Organisationsnummer</label>
                    <input type="text" id="company-orgno" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green"
                           placeholder="T.ex. 556123-4567">
                </div>

                <!-- Text input -->
                <div id="input-text" class="input-panel">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">Tariffbeskrivning</label>
                    <textarea id="tariff-text" rows="10" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green"
                              placeholder="Beskriv era tariffer här...

Exempel:
Småhus och företag, max 63A:
- Fast avgift: 185 kr/mån
- Energiavgift:
  - Höglast (06-22 vardagar): 0,25 kr/kWh
  - Låglast (22-06 + helger): 0,15 kr/kWh
- Effektavgift: 45 kr/kW (medel av 3 högsta topparna)

Gäller från 2025-01-01"></textarea>
                    <button onclick="parseText()" id="btn-parse-text"
                            class="mt-4 w-full bg-sourceful-green text-white py-3 px-4 rounded-lg hover:bg-sourceful-blue transition font-medium">
                        Analysera med AI
                    </button>
                </div>

                <!-- PDF input -->
                <div id="input-pdf" class="input-panel hidden">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">Ladda upp PDF</label>
                    <input type="file" id="tariff-pdf" accept=".pdf"
                           class="w-full border border-gray-300 rounded-lg p-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-sourceful-green/10 file:text-sourceful-green file:font-medium">
                    <button onclick="parsePDF()" id="btn-parse-pdf"
                            class="mt-4 w-full bg-sourceful-green text-white py-3 px-4 rounded-lg hover:bg-sourceful-blue transition font-medium">
                        Analysera PDF med AI
                    </button>
                </div>

                <!-- URL input -->
                <div id="input-url" class="input-panel hidden">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">URL till tariffbeskrivning</label>
                    <input type="url" id="tariff-url" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green"
                           placeholder="https://...">
                    <button onclick="parseURL()" id="btn-parse-url"
                            class="mt-4 w-full bg-sourceful-green text-white py-3 px-4 rounded-lg hover:bg-sourceful-blue transition font-medium">
                        Hämta och analysera
                    </button>
                </div>

                <!-- Status -->
                <div id="parse-status" class="mt-4 hidden">
                    <div class="flex items-center gap-2 text-sourceful-green">
                        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="status-text">Analyserar...</span>
                    </div>
                </div>

                <!-- Error -->
                <div id="parse-error" class="mt-4 hidden bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg"></div>
            </div>

            <!-- Right: Result -->
            <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-semibold text-sourceful-grey mb-4">2. Resultat</h2>

                <div id="result-placeholder" class="text-gray-400 text-center py-20">
                    Analyserade tariffer visas här...
                </div>

                <div id="result-content" class="hidden">
                    <!-- AI Warning -->
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-amber-800">AI-genererat resultat</h4>
                                <p class="text-sm text-amber-700 mt-1">
                                    Detta resultat är automatiskt genererat av AI och kan innehålla fel.
                                    <strong>Granska alla värden noggrant</strong> innan du använder dem i produktion.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Tariff Editor -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-medium text-sourceful-grey">Granska och redigera tariffer:</h3>
                            <button onclick="toggleRawJson()" class="text-sm text-sourceful-green hover:underline">
                                Visa/dölj JSON
                            </button>
                        </div>

                        <!-- Editable tariff cards -->
                        <div id="tariff-editor" class="space-y-4">
                            <!-- Filled by JavaScript -->
                        </div>

                        <!-- Raw JSON (hidden by default) -->
                        <div id="tariff-json" class="hidden mt-4">
                            <div id="tariff-preview" class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-auto border border-gray-200">
                                <pre class="text-sm text-sourceful-grey"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Download options -->
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="font-medium text-sourceful-grey mb-3">3. Ladda ner</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="downloadPackage()" id="btn-download"
                                    class="bg-sourceful-teal text-sourceful-grey py-3 px-4 rounded-lg hover:bg-sourceful-teal/80 transition flex items-center justify-center gap-2 font-bold">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                ZIP-paket
                            </button>
                            <button onclick="downloadExcel()" id="btn-excel"
                                    class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 font-bold">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Excel
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">
                            ZIP innehåller: app.py, Dockerfile, docker-compose.yml, OpenAPI-spec.
                            Excel är för presentation och granskning.
                        </p>
                    </div>

                    <!-- Preview files -->
                    <div class="mt-6 border-t border-gray-200 pt-4">
                        <button onclick="togglePreview()" class="text-sourceful-green text-sm hover:underline font-medium">
                            Visa/dölj filförhandsvisning
                        </button>
                        <div id="file-preview" class="hidden mt-4">
                            <div class="flex gap-2 mb-2 overflow-x-auto">
                                <button onclick="showFile('app.py')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">app.py</button>
                                <button onclick="showFile('docker-compose.yml')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">docker-compose.yml</button>
                                <button onclick="showFile('README.md')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">README.md</button>
                                <button onclick="showFile('tariffs.json')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">tariffs.json</button>
                            </div>
                            <div id="file-content" class="bg-sourceful-grey text-gray-100 p-4 rounded-lg overflow-auto max-h-80">
                                <pre class="text-sm"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="gradient-bg text-white mt-12">
        <div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <svg width="32" height="32" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" fill="#00FF84"/>
                        <path d="M50 20L65 45H55V80H45V45H35L50 20Z" fill="#2B2B2B"/>
                    </svg>
                    <div>
                        <p class="font-semibold">Sourceful Labs AB</p>
                        <p class="text-sm text-gray-400">Optimerar energianvändning</p>
                    </div>
                </div>
                <div class="text-center md:text-right text-sm text-gray-400">
                    <p>
                        Baserat på <a href="https://github.com/RI-SE/Eltariff-API" class="text-sourceful-teal hover:underline">RISE Eltariff API-standarden</a>
                    </p>
                    <p class="mt-1">
                        <a href="https://sourceful.energy" class="text-sourceful-teal hover:underline">sourceful.energy</a> |
                        <a href="https://elnätsavgift.se" class="text-sourceful-teal hover:underline">elnätsavgift.se</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let parsedTariffs = null;
        let generatedFiles = null;

        function showTab(tab) {
            document.querySelectorAll('.input-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById('input-' + tab).classList.remove('hidden');
            document.querySelectorAll('[id^="tab-"]').forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('text-gray-500');
            });
            document.getElementById('tab-' + tab).classList.add('tab-active');
            document.getElementById('tab-' + tab).classList.remove('text-gray-500');
        }

        function showStatus(msg) {
            document.getElementById('parse-status').classList.remove('hidden');
            document.getElementById('status-text').textContent = msg;
            document.getElementById('parse-error').classList.add('hidden');
        }

        function hideStatus() {
            document.getElementById('parse-status').classList.add('hidden');
        }

        function showError(msg) {
            hideStatus();
            const el = document.getElementById('parse-error');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function showResult(tariffs) {
            parsedTariffs = tariffs;
            document.getElementById('result-placeholder').classList.add('hidden');
            document.getElementById('result-content').classList.remove('hidden');
            document.getElementById('tariff-preview').querySelector('pre').textContent =
                JSON.stringify(tariffs, null, 2);

            // Render editable tariff cards
            renderTariffEditor(tariffs);
        }

        function toggleRawJson() {
            const jsonDiv = document.getElementById('tariff-json');
            jsonDiv.classList.toggle('hidden');
        }

        function renderTariffEditor(tariffs) {
            const container = document.getElementById('tariff-editor');
            container.innerHTML = '';

            if (!tariffs.tariffs) return;

            tariffs.tariffs.forEach((tariff, idx) => {
                const card = document.createElement('div');
                card.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
                card.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Tariffnamn</label>
                        <input type="text" value="${tariff.name || ''}"
                               onchange="updateTariff(${idx}, 'name', this.value)"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green">
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Beskrivning</label>
                        <input type="text" value="${tariff.description || ''}"
                               onchange="updateTariff(${idx}, 'description', this.value)"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green">
                    </div>

                    ${renderPriceSection('Fasta avgifter', tariff.fixedPrice, idx, 'fixedPrice')}
                    ${renderPriceSection('Energiavgifter (kr/kWh)', tariff.energyPrice, idx, 'energyPrice')}
                    ${renderPriceSection('Effektavgifter (kr/kW)', tariff.powerPrice, idx, 'powerPrice')}
                `;
                container.appendChild(card);
            });
        }

        function renderPriceSection(title, priceElement, tariffIdx, priceType) {
            if (!priceElement || !priceElement.components || !priceElement.components.length) {
                return '';
            }

            let rows = priceElement.components.map((comp, compIdx) => `
                <tr class="border-b border-gray-100">
                    <td class="py-2 pr-2">
                        <input type="text" value="${comp.name || ''}"
                               onchange="updateComponent(${tariffIdx}, '${priceType}', ${compIdx}, 'name', this.value)"
                               class="w-full border border-gray-200 rounded px-2 py-1 text-sm">
                    </td>
                    <td class="py-2 px-2">
                        <input type="number" step="0.01" value="${comp.price?.priceIncVat || 0}"
                               onchange="updateComponent(${tariffIdx}, '${priceType}', ${compIdx}, 'priceIncVat', parseFloat(this.value))"
                               class="w-20 border border-gray-200 rounded px-2 py-1 text-sm text-right">
                    </td>
                    <td class="py-2 pl-2 text-sm text-gray-500">${comp.unit || (priceType === 'fixedPrice' ? 'kr' : '')}</td>
                </tr>
            `).join('');

            return `
                <div class="mb-3">
                    <h4 class="text-xs font-semibold text-sourceful-grey mb-2 uppercase tracking-wide">${title}</h4>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-xs text-gray-500 border-b">
                                <th class="pb-1">Namn</th>
                                <th class="pb-1">Pris</th>
                                <th class="pb-1">Enhet</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function updateTariff(idx, field, value) {
            if (parsedTariffs && parsedTariffs.tariffs[idx]) {
                parsedTariffs.tariffs[idx][field] = value;
                updateJsonPreview();
            }
        }

        function updateComponent(tariffIdx, priceType, compIdx, field, value) {
            if (parsedTariffs?.tariffs[tariffIdx]?.[priceType]?.components[compIdx]) {
                if (field === 'priceIncVat') {
                    parsedTariffs.tariffs[tariffIdx][priceType].components[compIdx].price.priceIncVat = value;
                    // Auto-calculate ex VAT (25%)
                    parsedTariffs.tariffs[tariffIdx][priceType].components[compIdx].price.priceExVat = value / 1.25;
                } else {
                    parsedTariffs.tariffs[tariffIdx][priceType].components[compIdx][field] = value;
                }
                updateJsonPreview();
            }
        }

        function updateJsonPreview() {
            document.getElementById('tariff-preview').querySelector('pre').textContent =
                JSON.stringify(parsedTariffs, null, 2);
        }

        async function parseText() {
            const text = document.getElementById('tariff-text').value;
            const companyName = document.getElementById('company-name').value;

            if (!text.trim()) {
                showError('Ange en tariffbeskrivning');
                return;
            }

            showStatus('Analyserar med AI...');

            try {
                const formData = new FormData();
                formData.append('content', text);
                if (companyName) formData.append('company_name', companyName);

                const response = await fetch('/api/parse/text', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte analysera');
                }

                const result = await response.json();
                hideStatus();
                showResult(result);
            } catch (e) {
                showError(e.message);
            }
        }

        async function parsePDF() {
            const fileInput = document.getElementById('tariff-pdf');
            const companyName = document.getElementById('company-name').value;

            if (!fileInput.files.length) {
                showError('Välj en PDF-fil');
                return;
            }

            showStatus('Laddar upp och analyserar PDF...');

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                if (companyName) formData.append('company_name', companyName);

                const response = await fetch('/api/parse/pdf', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte analysera PDF');
                }

                const result = await response.json();
                hideStatus();
                showResult(result);
            } catch (e) {
                showError(e.message);
            }
        }

        async function parseURL() {
            const url = document.getElementById('tariff-url').value;
            const companyName = document.getElementById('company-name').value;

            if (!url.trim()) {
                showError('Ange en URL');
                return;
            }

            showStatus('Hämtar och analyserar URL...');

            try {
                const formData = new FormData();
                formData.append('url', url);
                if (companyName) formData.append('company_name', companyName);

                const response = await fetch('/api/parse/url', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte analysera URL');
                }

                const result = await response.json();
                hideStatus();
                showResult(result);
            } catch (e) {
                showError(e.message);
            }
        }

        async function downloadPackage() {
            if (!parsedTariffs) {
                showError('Analysera tariffer först');
                return;
            }

            const companyName = document.getElementById('company-name').value || 'Mitt Elnätsbolag';
            const companyOrgNo = document.getElementById('company-orgno').value || '556000-0000';

            showStatus('Genererar paket...');

            try {
                const response = await fetch('/api/generate/package', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        company_name: companyName,
                        company_org_no: companyOrgNo
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte generera paket');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = companyName.toLowerCase().replace(/\s+/g, '-') + '-tariff-api.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                hideStatus();
            } catch (e) {
                showError(e.message);
            }
        }

        async function downloadExcel() {
            if (!parsedTariffs) {
                showError('Analysera tariffer först');
                return;
            }

            const companyName = document.getElementById('company-name').value || 'Mitt Elnätsbolag';
            const companyOrgNo = document.getElementById('company-orgno').value || '556000-0000';

            showStatus('Genererar Excel...');

            try {
                const response = await fetch('/api/generate/excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        company_name: companyName,
                        company_org_no: companyOrgNo
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte generera Excel');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = companyName.toLowerCase().replace(/\s+/g, '-') + '-tariffer.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                hideStatus();
            } catch (e) {
                showError(e.message);
            }
        }

        async function togglePreview() {
            const preview = document.getElementById('file-preview');
            if (preview.classList.contains('hidden')) {
                if (!generatedFiles) {
                    await loadPreview();
                }
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        async function loadPreview() {
            if (!parsedTariffs) return;

            const companyName = document.getElementById('company-name').value || 'Mitt Elnätsbolag';
            const companyOrgNo = document.getElementById('company-orgno').value || '556000-0000';

            try {
                const response = await fetch('/api/generate/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        company_name: companyName,
                        company_org_no: companyOrgNo
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    generatedFiles = result.files;
                    showFile('README.md');
                }
            } catch (e) {
                console.error(e);
            }
        }

        function showFile(filename) {
            if (!generatedFiles || !generatedFiles[filename]) return;

            document.getElementById('file-content').querySelector('pre').textContent =
                generatedFiles[filename];

            document.querySelectorAll('.file-tab').forEach(t => {
                t.classList.remove('bg-sourceful-green/20', 'text-sourceful-green');
                t.classList.add('bg-gray-100');
            });
            event.target.classList.remove('bg-gray-100');
            event.target.classList.add('bg-sourceful-green/20', 'text-sourceful-green');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eltariff AI - Skapa RISE-kompatibelt API | Sourceful</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PMJLW2HNPT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-PMJLW2HNPT');
    </script>
    <meta name="description" content="Konvertera dina eln√§tstariffer till maskinl√§sbart RISE API-format med AI. Gratis verktyg fr√•n Sourceful Labs AB.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sourceful': {
                            'grey': '#2B2B2B',
                            'blue': '#2F4A66',
                            'green': '#017E7A',
                            'teal': '#00FF84',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .gradient-bg { background: linear-gradient(135deg, #2B2B2B 0%, #2F4A66 100%); }
        @keyframes progress {
            0% { width: 0%; margin-left: 0%; }
            50% { width: 30%; margin-left: 35%; }
            100% { width: 0%; margin-left: 100%; }
        }
        .animate-progress {
            animation: progress 2s ease-in-out infinite;
        }
        /* Terminal styling */
        .terminal {
            background: #1a1a2e;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
        }
        .terminal-line {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .cursor-blink::after {
            content: '‚ñä';
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- Header -->
    <header class="gradient-bg text-white">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center gap-4">
                    <img src="/static/sourceful-logo.png"
                         alt="Sourceful" class="h-10">
                    <div class="border-l border-gray-500 pl-4">
                        <h1 class="text-2xl font-bold">Eltariff AI</h1>
                        <p class="text-sm text-gray-300">Skapa RISE-kompatibelt API</p>
                    </div>
                </a>
                <nav class="flex gap-6">
                    <a href="/" class="text-sourceful-teal font-medium">Skapa ditt egna API</a>
                    <a href="/explorer" class="text-gray-300 hover:text-white">Utforska befintliga APIer</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <!-- Introduction -->
        <div class="bg-sourceful-green/10 border border-sourceful-green/30 rounded-lg p-6 mb-8">
            <h2 class="text-lg font-semibold text-sourceful-grey mb-2">Vad √§r detta?</h2>
            <p class="text-sourceful-grey/80">
                Detta verktyg hj√§lper svenska eln√§tsbolag att skapa ett maskinl√§sbart API f√∂r sina tariffer
                enligt <a href="https://github.com/RI-SE/Eltariff-API" class="text-sourceful-green underline hover:text-sourceful-blue">RISE Eltariff API-standarden</a>.
                Ladda upp din tariffbeskrivning, s√• genererar AI:n ett komplett deployment-paket med Docker.
            </p>
            <p class="text-sm text-sourceful-grey/60 mt-2">
                Rate limit: 10 AI-analyser per timme.
            </p>

            <!-- Expandable RISE explanation -->
            <details class="mt-4">
                <summary class="cursor-pointer text-sourceful-green font-medium hover:underline">
                    Vad √§r RISE Eltariff API-standarden?
                </summary>
                <div class="mt-3 pl-4 border-l-2 border-sourceful-green/30 text-sm text-sourceful-grey/80 space-y-3">
                    <p>
                        <strong>RISE Eltariff API</strong> √§r en √∂ppen standard utvecklad av RISE (Research Institutes of Sweden)
                        tillsammans med svenska eln√§tsbolag f√∂r att g√∂ra eln√§tstariffer maskinl√§sbara.
                    </p>
                    <p>
                        <strong>Varf√∂r beh√∂vs detta?</strong> Idag publicerar de flesta eln√§tsbolag sina tariffer som PDF:er eller
                        webbsidor som √§r sv√•ra f√∂r appar och tj√§nster att tolka automatiskt. Med ett standardiserat API kan:
                    </p>
                    <ul class="list-disc list-inside space-y-1 ml-2">
                        <li>Energiappar visa exakta kostnader f√∂r dina kunder</li>
                        <li>Smarta hem optimera f√∂rbrukning baserat p√• tariffen</li>
                        <li>Elbilsladdning schemal√§ggas n√§r det √§r billigast</li>
                        <li>Konsumenter j√§mf√∂ra eln√§tskostnader enkelt</li>
                    </ul>
                    <p>
                        <strong>Hur fungerar standarden?</strong> API:et beskriver tre typer av avgifter:
                    </p>
                    <ul class="list-disc list-inside space-y-1 ml-2">
                        <li><strong>fixedPrice</strong> - Fasta avgifter (abonnemang, s√§kringsavgift)</li>
                        <li><strong>energyPrice</strong> - Energiavgifter per kWh (ofta tidsdifferentierade)</li>
                        <li><strong>powerPrice</strong> - Effektavgifter per kW (baserat p√• f√∂rbrukningstoppar)</li>
                    </ul>
                    <p>
                        Varje avgift kan ha tidsregler (h√∂glast/l√•glast, sommar/vinter) och ber√§kningsregler
                        (t.ex. snitt av 3 h√∂gsta effekttoppar).
                    </p>
                    <p class="text-xs text-gray-500 mt-2">
                        <a href="https://github.com/RI-SE/Eltariff-API" class="text-sourceful-green hover:underline" target="_blank">
                            L√§s mer p√• GitHub
                        </a> |
                        <a href="/explorer" class="text-sourceful-green hover:underline">
                            Se befintliga API:er
                        </a>
                    </p>
                </div>
            </details>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left: Input -->
            <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-semibold text-sourceful-grey mb-4">1. Ange tariffer</h2>
                <p class="text-sm text-gray-500 mb-6">Fyll i ett eller flera av f√§lten nedan. AI:n extraherar automatiskt f√∂retagsnamn och tariffdata.</p>

                <!-- URL input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            URL till tariffwebbsida
                        </span>
                    </label>
                    <input type="url" id="tariff-url" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green"
                           placeholder="https://www.elnatbolag.se/tariffer">
                </div>

                <!-- PDF input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            PDF-dokument
                        </span>
                    </label>
                    <input type="file" id="tariff-pdf" accept=".pdf"
                           class="w-full border border-gray-300 rounded-lg p-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-sourceful-green/10 file:text-sourceful-green file:font-medium hover:file:bg-sourceful-green/20 cursor-pointer">
                </div>

                <!-- Text input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-sourceful-grey mb-1">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Fritext / Klistra in
                        </span>
                    </label>
                    <textarea id="tariff-text" rows="6" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green"
                              placeholder="Klistra in tariffbeskrivning h√§r...

Exempel:
Sm√•hus 16-25A: Fast 185 kr/m√•n, H√∂glast 0.25 kr/kWh, L√•glast 0.15 kr/kWh"></textarea>
                </div>

                <!-- Analyze button -->
                <button onclick="analyzeAll()" id="btn-analyze"
                        class="w-full bg-sourceful-green text-white py-4 px-4 rounded-lg hover:bg-sourceful-blue transition font-semibold text-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Analysera med AI
                </button>

                <!-- Terminal Log -->
                <div id="terminal-log" class="mt-6 hidden">
                    <div class="terminal rounded-lg overflow-hidden border border-gray-700">
                        <div class="flex items-center gap-2 px-3 py-2 bg-gray-800 border-b border-gray-700">
                            <div class="flex gap-1.5">
                                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            </div>
                            <span class="text-gray-400 text-xs ml-2">eltariff-ai ‚Äî parsing</span>
                        </div>
                        <div id="terminal-content" class="p-4 h-48 overflow-y-auto text-gray-300">
                            <!-- Terminal lines added by JS -->
                        </div>
                    </div>
                </div>

                <!-- Error -->
                <div id="parse-error" class="mt-4 hidden bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg"></div>
            </div>

            <!-- Right: Result -->
            <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-semibold text-sourceful-grey mb-4">2. Resultat</h2>

                <div id="result-placeholder" class="text-gray-400 text-center py-20">
                    Analyserade tariffer visas h√§r...
                </div>

                <div id="result-content" class="hidden">
                    <!-- AI Warning -->
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-amber-800">AI-genererat resultat</h4>
                                <p class="text-sm text-amber-700 mt-1">
                                    Detta resultat √§r automatiskt genererat av AI och kan inneh√•lla fel.
                                    <strong>Granska alla v√§rden noggrant</strong> innan du anv√§nder dem i produktion.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Improvement Prompt -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                        <h4 class="font-medium text-purple-900 mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                            </svg>
                            F√∂rb√§ttra med AI
                        </h4>
                        <div class="flex gap-2">
                            <input type="text" id="ai-improvement"
                                   placeholder="T.ex: L√§gg till effektavgift p√• 45 kr/kW, √§ndra namn till..."
                                   class="flex-1 border border-purple-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-400 focus:border-purple-400">
                            <button onclick="improveWithAI()" id="btn-improve"
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm font-medium whitespace-nowrap">
                                Uppdatera
                            </button>
                        </div>
                        <p class="text-xs text-purple-600 mt-2">
                            Beskriv vad som ska √§ndras s√• fixar AI:n det √•t dig.
                        </p>
                    </div>

                    <!-- Tariff Editor -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-medium text-sourceful-grey">Granska och redigera tariffer:</h3>
                            <button onclick="toggleRawJson()" class="text-sm text-sourceful-green hover:underline">
                                Visa/d√∂lj JSON
                            </button>
                        </div>

                        <!-- Editable tariff cards -->
                        <div id="tariff-editor" class="space-y-4">
                            <!-- Filled by JavaScript -->
                        </div>

                        <!-- Raw JSON (hidden by default) -->
                        <div id="tariff-json" class="hidden mt-4">
                            <div id="tariff-preview" class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-auto border border-gray-200">
                                <pre class="text-sm text-sourceful-grey"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Download options -->
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="font-medium text-sourceful-grey mb-3">3. Ladda ner</h3>

                        <!-- JSON download - primary for data -->
                        <div class="mb-4">
                            <button onclick="downloadJson()" id="btn-json"
                                    class="w-full bg-sourceful-green text-white py-3 px-4 rounded-lg hover:bg-sourceful-blue transition flex items-center justify-center gap-2 font-bold">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Ladda ner JSON (RISE-format)
                            </button>
                            <p class="text-xs text-gray-500 mt-1">
                                Tariffdata i RISE API-standardformat. Kan anv√§ndas direkt i din egen implementation.
                            </p>
                        </div>

                        <!-- Secondary options -->
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="downloadPackage()" id="btn-download"
                                    class="bg-sourceful-grey text-white py-2.5 px-4 rounded-lg hover:bg-sourceful-blue transition flex items-center justify-center gap-2 font-medium text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                </svg>
                                Docker-paket (ZIP)
                            </button>
                            <button onclick="downloadExcel()" id="btn-excel"
                                    class="bg-green-600 text-white py-2.5 px-4 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 font-medium text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Excel (granskning)
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <strong>Docker-paket:</strong> Komplett f√§rdigt API med app.py, Dockerfile, docker-compose.yml.<br>
                            <strong>Excel:</strong> F√∂r presentation, granskning och delning med kollegor.
                        </p>
                    </div>

                    <!-- API Preview -->
                    <div class="mt-6 border-t border-gray-200 pt-4">
                        <button onclick="toggleApiPreview()" class="text-sourceful-green text-sm hover:underline font-medium flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            F√∂rhandsgranska ditt API
                        </button>
                        <div id="api-preview" class="hidden mt-4">
                            <div class="bg-sourceful-blue/5 border border-sourceful-blue/20 rounded-lg p-4">
                                <h4 class="font-medium text-sourceful-grey mb-3">S√• h√§r kommer ditt API se ut:</h4>

                                <div class="space-y-3">
                                    <!-- Endpoint 1 -->
                                    <div class="bg-white rounded border border-gray-200 overflow-hidden">
                                        <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 border-b">
                                            <span class="bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded">GET</span>
                                            <code class="text-sm text-sourceful-grey">/gridtariff/v0/tariffs</code>
                                        </div>
                                        <div class="p-3">
                                            <pre id="api-preview-list" class="text-xs text-gray-600 overflow-auto max-h-32"></pre>
                                        </div>
                                    </div>

                                    <!-- Endpoint 2 -->
                                    <div class="bg-white rounded border border-gray-200 overflow-hidden">
                                        <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 border-b">
                                            <span class="bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded">GET</span>
                                            <code class="text-sm text-sourceful-grey">/gridtariff/v0/tariffs/{id}</code>
                                        </div>
                                        <div class="p-3">
                                            <pre id="api-preview-single" class="text-xs text-gray-600 overflow-auto max-h-32"></pre>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-xs text-gray-500 mt-3">
                                    Detta √§r en f√∂rhandsvisning. Det faktiska API:et skapas n√§r du laddar ner och deployar paketet.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Preview files -->
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <button onclick="togglePreview()" class="text-sourceful-green text-sm hover:underline font-medium">
                            Visa/d√∂lj genererade filer
                        </button>
                        <div id="file-preview" class="hidden mt-4">
                            <div class="flex gap-2 mb-2 overflow-x-auto">
                                <button onclick="showFile('app.py')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">app.py</button>
                                <button onclick="showFile('docker-compose.yml')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">docker-compose.yml</button>
                                <button onclick="showFile('README.md')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">README.md</button>
                                <button onclick="showFile('tariffs.json')" class="file-tab px-3 py-1 bg-gray-100 rounded text-sm font-medium">tariffs.json</button>
                            </div>
                            <div id="file-content" class="bg-sourceful-grey text-gray-100 p-4 rounded-lg overflow-auto max-h-80">
                                <pre class="text-sm"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- About Section -->
    <section class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-4xl mx-auto px-4 py-12 sm:px-6 lg:px-8">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Varf√∂r detta finns -->
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-sourceful-grey mb-4">Varf√∂r eltariff.sourceful.dev finns</h3>
                    <div class="text-sm text-gray-600 space-y-3">
                        <p>
                            Det h√§r projektet √§r byggt utifr√•n en enkel √∂vertygelse:
                            att system fungerar b√§ttre n√§r de √§r begripliga, √∂ppna och m√∂jliga att kontrollera.
                        </p>
                        <p>
                            Elmarknaden √§r idag tekniskt komplex, men beh√∂ver inte vara ogenomtr√§nglig.
                            N√§r data, priser och regler g√∂ms bakom st√§ngda gr√§nssnitt uppst√•r tr√∂ghet, misstro och d√•liga beslut ‚Äì f√∂r bolag, f√∂r kunder och f√∂r systemet som helhet.
                        </p>
                        <p>
                            Vi tror p√• det motsatta. Att √∂ppna standarder och tillg√§ngliga API:er g√∂r hela ekosystemet starkare.
                            Att transparens skapar b√§ttre aff√§rer, b√§ttre teknik och ett stabilare elsystem.
                        </p>
                        <p class="text-gray-500 italic">
                            Marcus Aurelius skrev att vi inte ska klaga p√• v√§rlden som den √§r, utan fokusera p√• vad det inneb√§r att vara en b√§ttre m√§nniska i den.
                            F√∂r oss betyder det att ta ansvar d√§r vi kan ‚Äì bygga det vi sj√§lva saknar, och g√∂ra det p√• ett s√§tt vi kan st√• f√∂r.
                        </p>
                        <p class="font-medium text-sourceful-grey">
                            Det h√§r √§r ett litet bidrag i den riktningen.
                        </p>
                    </div>
                </div>

                <!-- Om projektet -->
                <div class="bg-sourceful-green/5 rounded-lg p-6 border border-sourceful-green/20">
                    <h3 class="text-lg font-semibold text-sourceful-grey mb-4">Om projektet</h3>
                    <div class="text-sm text-gray-600 space-y-3">
                        <p>
                            <strong>Byggt av Sourceful Labs AB</strong><br>
                            <span class="text-gray-500">Org.nr: 559382-0458</span>
                        </p>
                        <p>
                            Detta √§r ett √∂ppet, frist√•ende projekt som vi har byggt f√∂r att visa hur enkelt det kan vara.
                            Med dagens verktyg ‚Äì inte minst moderna AI-system ‚Äì finns det inga tekniska urs√§kter f√∂r att elbolag eller n√§tbolag inte ska kunna tillhandah√•lla tydliga, v√§ldokumenterade API:er.
                        </p>
                        <p>
                            Vi har byggt detta f√∂r att vi tror att hela branschen tj√§nar p√• det.
                            N√§r tr√∂sklar s√§nks kan fler akt√∂rer f√∂rst√•, bygga vidare och fatta b√§ttre beslut.
                        </p>
                        <p>
                            Vill ni prata mer om vad vi arbetar med?<br>
                            <a href="mailto:info@sourceful-labs.com" class="text-sourceful-green hover:underline font-medium">info@sourceful-labs.com</a>
                        </p>
                        <p class="text-gray-500 text-xs pt-2 border-t border-gray-200">
                            Byggt med omsorg i Kalmar. V√•r √∂vertygelse √§r enkel: framtidens elsystem kr√§ver √∂ppna standarder, tillg√§ngliga API:er och lokalt ansvarstagande.
                        </p>
                        <p class="font-medium text-sourceful-grey">
                            Se detta som v√•r julklapp till er i energibranschen.<br>
                            <span class="text-gray-500 font-normal">Inte f√∂r att vara sn√§ll ‚Äì utan f√∂r att det √§r r√§tt sak att g√∂ra.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Email Modal -->
    <div id="email-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div class="gradient-bg px-6 py-4">
                <h3 class="text-xl font-bold text-white">Kom ig√•ng med Eltariff AI</h3>
                <p class="text-gray-300 text-sm mt-1">Gratis att anv√§nda ‚Äî vi beh√∂ver bara din e-post</p>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">
                    Ange din e-postadress f√∂r att b√∂rja analysera tariffer med AI.
                    Vi skickar inga spam ‚Äî detta hj√§lper oss bara f√∂rst√• vilka som anv√§nder verktyget.
                </p>
                <input type="email" id="user-email"
                       placeholder="din@epost.se"
                       class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:ring-2 focus:ring-sourceful-green focus:border-sourceful-green mb-4">
                <button onclick="submitEmail()"
                        class="w-full bg-sourceful-green text-white py-3 px-4 rounded-lg hover:bg-sourceful-blue transition font-semibold">
                    Forts√§tt
                </button>
                <p class="text-xs text-gray-400 mt-3 text-center">
                    Genom att forts√§tta godk√§nner du att vi sparar din e-postadress.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="gradient-bg text-white">
        <div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <a href="https://sourceful.energy" target="_blank">
                        <img src="/static/sourceful-logo.png"
                             alt="Sourceful" class="h-8">
                    </a>
                    <div class="border-l border-gray-500 pl-3">
                        <p class="font-semibold">Sourceful Labs AB</p>
                        <p class="text-sm text-gray-400">The Local Execution Layer</p>
                    </div>
                </div>
                <div class="text-center md:text-right text-sm text-gray-400">
                    <p>
                        Baserat p√• <a href="https://github.com/RI-SE/Eltariff-API" class="text-sourceful-teal hover:underline">RISE Eltariff API-standarden</a>
                    </p>
                    <p class="mt-1">
                        <a href="https://sourceful.energy" class="text-sourceful-teal hover:underline">sourceful.energy</a> |
                        <a href="https://eln√§tsavgift.se" class="text-sourceful-teal hover:underline">eln√§tsavgift.se</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let parsedTariffs = null;
        let generatedFiles = null;
        const FORMSPARK_URL = 'https://submit-form.com/mw3ANw208';

        // ========== EMAIL & TRACKING ==========
        function getUserEmail() {
            return localStorage.getItem('eltariff_email');
        }

        function setUserEmail(email) {
            localStorage.setItem('eltariff_email', email);
        }

        function showEmailModal() {
            document.getElementById('email-modal').classList.remove('hidden');
            document.getElementById('user-email').focus();
        }

        function hideEmailModal() {
            document.getElementById('email-modal').classList.add('hidden');
        }

        async function submitEmail() {
            const email = document.getElementById('user-email').value.trim();
            if (!email || !email.includes('@')) {
                document.getElementById('user-email').classList.add('border-red-500');
                return;
            }

            setUserEmail(email);
            hideEmailModal();

            // Track registration in Formspark
            await trackEvent('registration', { email });

            // Continue with the original action
            if (window.pendingAnalysis) {
                window.pendingAnalysis();
                window.pendingAnalysis = null;
            }
        }

        async function trackEvent(action, data = {}) {
            const email = getUserEmail();
            try {
                await fetch(FORMSPARK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        action: action,
                        timestamp: new Date().toISOString(),
                        ...data
                    })
                });
            } catch (e) {
                console.log('Tracking failed:', e);
            }
        }

        // ========== TERMINAL LOG ==========
        function showTerminal() {
            const terminal = document.getElementById('terminal-log');
            terminal.classList.remove('hidden');
            document.getElementById('terminal-content').innerHTML = '';
            document.getElementById('parse-error').classList.add('hidden');
            document.getElementById('btn-analyze').disabled = true;
            document.getElementById('btn-analyze').classList.add('opacity-50', 'cursor-not-allowed');
        }

        function hideTerminal() {
            document.getElementById('btn-analyze').disabled = false;
            document.getElementById('btn-analyze').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function termLog(message, type = 'info') {
            const content = document.getElementById('terminal-content');
            const line = document.createElement('div');
            line.className = 'terminal-line mb-1';

            const timestamp = new Date().toLocaleTimeString('sv-SE');
            const colors = {
                'info': 'text-gray-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'ai': 'text-purple-400'
            };

            const icons = {
                'info': '‚Üí',
                'success': '‚úì',
                'error': '‚úó',
                'warning': '‚ö†',
                'ai': 'ü§ñ'
            };

            line.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="${colors[type]}">${icons[type]}</span> ${message}`;
            content.appendChild(line);
            content.scrollTop = content.scrollHeight;
        }

        function termLogTyping(message) {
            const content = document.getElementById('terminal-content');
            const line = document.createElement('div');
            line.className = 'terminal-line mb-1 cursor-blink';
            line.innerHTML = `<span class="text-purple-400">ü§ñ</span> <span class="text-purple-300">${message}</span>`;
            content.appendChild(line);
            content.scrollTop = content.scrollHeight;
            return line;
        }

        function showError(msg) {
            hideTerminal();
            const el = document.getElementById('parse-error');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function showResult(tariffs) {
            parsedTariffs = tariffs;
            document.getElementById('result-placeholder').classList.add('hidden');
            document.getElementById('result-content').classList.remove('hidden');
            document.getElementById('tariff-preview').querySelector('pre').textContent =
                JSON.stringify(tariffs, null, 2);

            // Render editable tariff cards
            renderTariffEditor(tariffs);
        }

        function toggleRawJson() {
            const jsonDiv = document.getElementById('tariff-json');
            jsonDiv.classList.toggle('hidden');
        }

        function renderTariffEditor(tariffs) {
            const container = document.getElementById('tariff-editor');
            container.innerHTML = '';

            if (!tariffs.tariffs) return;

            tariffs.tariffs.forEach((tariff, idx) => {
                const card = document.createElement('div');
                card.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50 mb-4';

                // Check if this tariff has power price with description (important info)
                const hasPowerInfo = tariff.powerPrice?.description || tariff.description?.includes('ffekt');

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <input type="text" value="${tariff.name || ''}"
                                   onchange="updateTariff(${idx}, 'name', this.value)"
                                   class="text-lg font-semibold text-sourceful-grey bg-transparent border-b border-transparent hover:border-gray-300 focus:border-sourceful-green focus:outline-none w-full">
                            <div class="text-xs text-gray-400 mt-1">${tariff.companyName || ''}</div>
                        </div>
                    </div>

                    ${tariff.description ? `
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="text-xs font-medium text-blue-700 mb-1">M√•lgrupp & Villkor</div>
                        <textarea onchange="updateTariff(${idx}, 'description', this.value)"
                                  class="w-full text-sm text-blue-900 bg-transparent border-none resize-none focus:outline-none"
                                  rows="2">${tariff.description}</textarea>
                    </div>
                    ` : ''}

                    <div class="grid gap-4">
                        ${renderPriceSection('Fasta avgifter', tariff.fixedPrice, idx, 'fixedPrice')}
                        ${renderPriceSection('Energiavgifter', tariff.energyPrice, idx, 'energyPrice')}
                        ${renderPriceSection('Effektavgifter', tariff.powerPrice, idx, 'powerPrice')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderPriceSection(title, priceElement, tariffIdx, priceType) {
            if (!priceElement || !priceElement.components || !priceElement.components.length) {
                return '';
            }

            // Check for important description (especially for power prices)
            const hasDescription = priceElement.description && priceElement.description.trim();
            const isPowerPrice = priceType === 'powerPrice';

            let rows = priceElement.components.map((comp, compIdx) => {
                const unit = comp.unit || (priceType === 'fixedPrice' ? 'kr/m√•n' : '');
                return `
                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                    <div class="flex-1">
                        <input type="text" value="${comp.name || ''}"
                               onchange="updateComponent(${tariffIdx}, '${priceType}', ${compIdx}, 'name', this.value)"
                               class="text-sm bg-transparent border-b border-transparent hover:border-gray-300 focus:border-sourceful-green focus:outline-none">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" step="0.01" value="${comp.price?.priceIncVat || 0}"
                               onchange="updateComponent(${tariffIdx}, '${priceType}', ${compIdx}, 'priceIncVat', parseFloat(this.value))"
                               class="w-24 text-right font-medium border border-gray-200 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-sourceful-green">
                        <span class="text-xs text-gray-500 w-16">${unit}</span>
                    </div>
                </div>
            `}).join('');

            // Special styling for power prices with complex rules
            const sectionClass = isPowerPrice && hasDescription
                ? 'p-3 bg-amber-50 border border-amber-200 rounded-lg'
                : 'p-3 bg-white border border-gray-200 rounded-lg';

            const titleClass = isPowerPrice && hasDescription
                ? 'text-xs font-semibold text-amber-800 uppercase tracking-wide flex items-center gap-2'
                : 'text-xs font-semibold text-sourceful-grey uppercase tracking-wide';

            return `
                <div class="${sectionClass}">
                    <h4 class="${titleClass}">
                        ${isPowerPrice && hasDescription ? '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>' : ''}
                        ${title}
                    </h4>
                    ${hasDescription ? `
                    <div class="mt-2 mb-3 p-2 ${isPowerPrice ? 'bg-amber-100/50' : 'bg-gray-50'} rounded text-xs ${isPowerPrice ? 'text-amber-900' : 'text-gray-600'}">
                        <strong>Ber√§kningsregel:</strong> ${priceElement.description}
                    </div>
                    ` : ''}
                    <div class="mt-2">${rows}</div>
                </div>
            `;
        }

        function updateTariff(idx, field, value) {
            if (parsedTariffs && parsedTariffs.tariffs[idx]) {
                parsedTariffs.tariffs[idx][field] = value;
                updateJsonPreview();
            }
        }

        function updateComponent(tariffIdx, priceType, compIdx, field, value) {
            if (parsedTariffs?.tariffs[tariffIdx]?.[priceType]?.components[compIdx]) {
                if (field === 'priceIncVat') {
                    parsedTariffs.tariffs[tariffIdx][priceType].components[compIdx].price.priceIncVat = value;
                    // Auto-calculate ex VAT (25%)
                    parsedTariffs.tariffs[tariffIdx][priceType].components[compIdx].price.priceExVat = value / 1.25;
                } else {
                    parsedTariffs.tariffs[tariffIdx][priceType].components[compIdx][field] = value;
                }
                updateJsonPreview();
            }
        }

        function updateJsonPreview() {
            document.getElementById('tariff-preview').querySelector('pre').textContent =
                JSON.stringify(parsedTariffs, null, 2);
        }

        function toggleApiPreview() {
            const preview = document.getElementById('api-preview');
            preview.classList.toggle('hidden');

            if (!preview.classList.contains('hidden') && parsedTariffs) {
                // Show API preview
                const listPreview = document.getElementById('api-preview-list');
                const singlePreview = document.getElementById('api-preview-single');

                // Format list response
                listPreview.textContent = JSON.stringify({
                    tariffs: parsedTariffs.tariffs?.map(t => ({
                        id: t.id || "generated-uuid",
                        name: t.name,
                        description: t.description,
                        companyName: t.companyName
                    })) || []
                }, null, 2);

                // Format single tariff response
                if (parsedTariffs.tariffs?.length > 0) {
                    const firstTariff = parsedTariffs.tariffs[0];
                    singlePreview.textContent = JSON.stringify({
                        id: firstTariff.id || "generated-uuid",
                        name: firstTariff.name,
                        description: firstTariff.description,
                        validPeriod: firstTariff.validPeriod,
                        companyName: firstTariff.companyName,
                        fixedPrice: firstTariff.fixedPrice ? "..." : null,
                        energyPrice: firstTariff.energyPrice ? "..." : null,
                        powerPrice: firstTariff.powerPrice ? "..." : null
                    }, null, 2);
                }
            }
        }

        async function analyzeAll() {
            // Check for email first
            if (!getUserEmail()) {
                window.pendingAnalysis = analyzeAll;
                showEmailModal();
                return;
            }

            const url = document.getElementById('tariff-url').value.trim();
            const fileInput = document.getElementById('tariff-pdf');
            const text = document.getElementById('tariff-text').value.trim();

            const hasUrl = url.length > 0;
            const hasPdf = fileInput.files.length > 0;
            const hasText = text.length > 0;

            if (!hasUrl && !hasPdf && !hasText) {
                showError('Fyll i minst ett av f√§lten (URL, PDF eller fritext)');
                return;
            }

            // Show terminal
            showTerminal();
            termLog('Startar analys...', 'info');

            // Build form data with all available inputs
            const formData = new FormData();

            if (hasUrl) {
                termLog(`F√∂rbereder URL: ${url}`, 'info');
                formData.append('url', url);
            }
            if (hasPdf) {
                const fileName = fileInput.files[0].name;
                const fileSize = (fileInput.files[0].size / 1024).toFixed(1);
                termLog(`F√∂rbereder PDF: ${fileName} (${fileSize} KB)`, 'info');
                formData.append('file', fileInput.files[0]);
            }
            if (hasText) {
                termLog(`F√∂rbereder fritext: ${text.length} tecken`, 'info');
                formData.append('text', text);
            }

            // Track the analysis
            await trackEvent('analysis_started', {
                hasUrl,
                hasPdf,
                hasText,
                url: hasUrl ? url : null
            });

            try {
                termLog('Skickar till server...', 'info');

                // Simulate progress messages
                const progressMessages = [
                    { delay: 1500, msg: 'H√§mtar webbsida...', type: 'info' },
                    { delay: 3000, msg: 'Extraherar text fr√•n inneh√•ll...', type: 'info' },
                    { delay: 5000, msg: 'Skickar till AI f√∂r analys...', type: 'ai' },
                    { delay: 8000, msg: 'AI tolkar tariffstruktur...', type: 'ai' },
                    { delay: 12000, msg: 'AI identifierar priskomponenter...', type: 'ai' },
                ];

                const timeouts = progressMessages.map(p =>
                    setTimeout(() => termLog(p.msg, p.type), p.delay)
                );

                const response = await fetch('/api/parse/combined', {
                    method: 'POST',
                    body: formData
                });

                // Clear pending timeouts
                timeouts.forEach(t => clearTimeout(t));

                if (!response.ok) {
                    const error = await response.json();
                    termLog(`Fel: ${error.detail || 'Ok√§nt fel'}`, 'error');
                    throw new Error(error.detail || 'Kunde inte analysera');
                }

                const result = await response.json();
                const tariffCount = result.tariffs?.length || 0;

                termLog(`Analys klar!`, 'success');
                termLog(`Hittade ${tariffCount} tariff(er)`, 'success');

                // Track success
                await trackEvent('analysis_completed', { tariffCount });

                setTimeout(() => {
                    hideTerminal();
                    showResult(result);
                }, 1000);

            } catch (e) {
                termLog(`Fel: ${e.message}`, 'error');
                await trackEvent('analysis_failed', { error: e.message });

                setTimeout(() => {
                    showError(e.message);
                }, 1500);
            }
        }

        async function improveWithAI() {
            const instruction = document.getElementById('ai-improvement').value.trim();
            if (!instruction) {
                document.getElementById('ai-improvement').classList.add('border-red-500');
                setTimeout(() => document.getElementById('ai-improvement').classList.remove('border-red-500'), 2000);
                return;
            }

            if (!parsedTariffs) {
                showError('Ingen tariffdata att f√∂rb√§ttra');
                return;
            }

            showTerminal();
            termLog('Startar AI-f√∂rb√§ttring...', 'ai');
            termLog(`Instruktion: "${instruction}"`, 'info');

            try {
                termLog('Skickar till AI...', 'ai');

                const response = await fetch('/api/parse/improve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        instruction: instruction
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte f√∂rb√§ttra');
                }

                const result = await response.json();
                termLog('F√∂rb√§ttring klar!', 'success');

                await trackEvent('improvement_made', { instruction });

                setTimeout(() => {
                    hideTerminal();
                    showResult(result);
                    document.getElementById('ai-improvement').value = '';
                }, 1000);

            } catch (e) {
                termLog(`Fel: ${e.message}`, 'error');
                setTimeout(() => showError(e.message), 1500);
            }
        }

        async function downloadJson() {
            if (!parsedTariffs) {
                showError('Analysera tariffer f√∂rst');
                return;
            }

            const companyName = parsedTariffs.tariffs?.[0]?.companyName || 'Mitt Eln√§tsbolag';
            const companyOrgNo = parsedTariffs.tariffs?.[0]?.companyOrgNo || '556000-0000';

            showTerminal();
            termLog('Genererar JSON...', 'info');
            await trackEvent('download_json', { companyName });

            try {
                const response = await fetch('/api/generate/json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        company_name: companyName,
                        company_org_no: companyOrgNo
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte generera JSON');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = companyName.toLowerCase().replace(/\s+/g, '-') + '-tariffer.json';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                termLog('JSON-fil nedladdad!', 'success');
                setTimeout(() => hideTerminal(), 1000);
            } catch (e) {
                termLog(`Fel: ${e.message}`, 'error');
                setTimeout(() => showError(e.message), 1500);
            }
        }

        async function downloadPackage() {
            if (!parsedTariffs) {
                showError('Analysera tariffer f√∂rst');
                return;
            }

            const companyName = parsedTariffs.tariffs?.[0]?.companyName || 'Mitt Eln√§tsbolag';
            const companyOrgNo = parsedTariffs.tariffs?.[0]?.companyOrgNo || '556000-0000';

            showTerminal();
            termLog('Genererar Docker-paket...', 'info');
            await trackEvent('download_package', { companyName });

            try {
                const response = await fetch('/api/generate/package', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        company_name: companyName,
                        company_org_no: companyOrgNo
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte generera paket');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = companyName.toLowerCase().replace(/\s+/g, '-') + '-tariff-api.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                termLog('Docker-paket nedladdat!', 'success');
                setTimeout(() => hideTerminal(), 1000);
            } catch (e) {
                termLog(`Fel: ${e.message}`, 'error');
                setTimeout(() => showError(e.message), 1500);
            }
        }

        async function downloadExcel() {
            if (!parsedTariffs) {
                showError('Analysera tariffer f√∂rst');
                return;
            }

            const companyName = parsedTariffs.tariffs?.[0]?.companyName || 'Mitt Eln√§tsbolag';
            const companyOrgNo = parsedTariffs.tariffs?.[0]?.companyOrgNo || '556000-0000';

            showTerminal();
            termLog('Genererar Excel...', 'info');
            await trackEvent('download_excel', { companyName });

            try {
                const response = await fetch('/api/generate/excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        company_name: companyName,
                        company_org_no: companyOrgNo
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Kunde inte generera Excel');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = companyName.toLowerCase().replace(/\s+/g, '-') + '-tariffer.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                termLog('Excel-fil nedladdad!', 'success');
                setTimeout(() => hideTerminal(), 1000);
            } catch (e) {
                termLog(`Fel: ${e.message}`, 'error');
                setTimeout(() => showError(e.message), 1500);
            }
        }

        async function togglePreview() {
            const preview = document.getElementById('file-preview');
            if (preview.classList.contains('hidden')) {
                if (!generatedFiles) {
                    await loadPreview();
                }
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        async function loadPreview() {
            if (!parsedTariffs) return;

            // Get company info from parsed tariffs
            const companyName = parsedTariffs.tariffs?.[0]?.companyName || 'Mitt Eln√§tsbolag';
            const companyOrgNo = parsedTariffs.tariffs?.[0]?.companyOrgNo || '556000-0000';

            try {
                const response = await fetch('/api/generate/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tariffs_json: JSON.stringify(parsedTariffs),
                        company_name: companyName,
                        company_org_no: companyOrgNo
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    generatedFiles = result.files;
                    showFile('README.md');
                }
            } catch (e) {
                console.error(e);
            }
        }

        function showFile(filename) {
            if (!generatedFiles || !generatedFiles[filename]) return;

            document.getElementById('file-content').querySelector('pre').textContent =
                generatedFiles[filename];

            document.querySelectorAll('.file-tab').forEach(t => {
                t.classList.remove('bg-sourceful-green/20', 'text-sourceful-green');
                t.classList.add('bg-gray-100');
            });
            event.target.classList.remove('bg-gray-100');
            event.target.classList.add('bg-sourceful-green/20', 'text-sourceful-green');
        }

        // Load template from sessionStorage if coming from explorer
        function loadTemplateIfExists() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('template') === 'true') {
                const templateData = sessionStorage.getItem('tariffTemplate');

                if (templateData) {
                    try {
                        const tariffs = JSON.parse(templateData);

                        // Show the result directly - company info is in the tariff data
                        showResult(tariffs);

                        // Clean up sessionStorage
                        sessionStorage.removeItem('tariffTemplate');
                        sessionStorage.removeItem('templateCompanyName');
                        sessionStorage.removeItem('templateCompanyOrgNo');

                        // Clean up URL
                        window.history.replaceState({}, '', '/');

                        // Show a notification
                        showTemplateNotification();
                    } catch (e) {
                        console.error('Kunde inte ladda mall:', e);
                    }
                }
            }
        }

        function showTemplateNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-sourceful-green text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
            notification.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Mall laddad! Anpassa v√§rdena och ladda ner n√§r du √§r klar.</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Handle Enter key in email modal
        document.getElementById('user-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitEmail();
            }
        });

        // Handle Enter key in AI improvement
        document.getElementById('ai-improvement').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                improveWithAI();
            }
        });

        // Run on page load
        document.addEventListener('DOMContentLoaded', loadTemplateIfExists);
    </script>
</body>
</html>
